<div class="project-page">
  <div class="project-workspace">
    <div class="project-detail-layout" [class.with-inline-editor]="showInlineEditor()">
      <div class="project-detail">
        <div class="detail-header">
          <div>
            @if (sourceBreadcrumb()) {
              <div class="source-breadcrumb">{{ sourceBreadcrumb() }}</div>
            }
            <h2>{{ store.currentProjectName() }}</h2>
          </div>
          <div class="header-actions">
            <button mat-icon-button (click)="openEnvironmentManager()" title="Manage Environments">
              <mat-icon>layers</mat-icon>
            </button>
            <button mat-icon-button (click)="downloadProject()" title="Download JSON">
              <mat-icon>download</mat-icon>
            </button>
            <button mat-flat-button color="primary" (click)="openNewFlagEditor()">
              <mat-icon>add</mat-icon> Add Flag
            </button>
          </div>
        </div>

        @if (store.error()) {
          <div class="error-banner">{{ store.error() }}</div>
        }

        <section class="project-metadata-section">
          <div class="project-metadata-header">
            <h3>Project Metadata</h3>
            <button
              mat-stroked-button
              type="button"
              (click)="saveProjectMetadata()"
              [disabled]="metadataSaveDisabled()"
            >
              Save Metadata
            </button>
          </div>
          <app-metadata-editor
            [metadata]="projectMetadataDraft()"
            (metadataChange)="onProjectMetadataChange($event)"
          />
        </section>

        @if (store.loading() && !store.flagEntries().length) {
          <div class="loading">Loading flags...</div>
        } @else if (store.flagEntries().length) {
          <table mat-table [dataSource]="store.flagEntries()" class="flags-table">
            <ng-container matColumnDef="key">
              <th mat-header-cell *matHeaderCellDef>Key</th>
              <td mat-cell *matCellDef="let flag" class="col-key">{{ flag.key }}</td>
            </ng-container>

            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let flag">
                <mat-chip-set>
                  <mat-chip class="type-chip">{{ getFlagType(flag) }}</mat-chip>
                </mat-chip-set>
              </td>
            </ng-container>

            <ng-container matColumnDef="state">
              <th mat-header-cell *matHeaderCellDef>State</th>
              <td mat-cell *matCellDef="let flag">
                <mat-chip
                  class="state-badge"
                  [class.enabled]="flag.state === 'ENABLED'"
                  [highlighted]="flag.state === 'ENABLED'"
                >
                  {{ flag.state }}
                </mat-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="variants">
              <th mat-header-cell *matHeaderCellDef>Variants</th>
              <td mat-cell *matCellDef="let flag">
                <mat-chip-set>
                  @for (name of getVariantNames(flag); track name) {
                    <mat-chip class="variant-chip">{{ name }}</mat-chip>
                  }
                </mat-chip-set>
              </td>
            </ng-container>

            <ng-container matColumnDef="default">
              <th mat-header-cell *matHeaderCellDef>Default</th>
              <td mat-cell *matCellDef="let flag" class="col-default">
                {{ flag.defaultVariant ?? '-' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="targeting">
              <th mat-header-cell *matHeaderCellDef>Targeting</th>
              <td mat-cell *matCellDef="let flag">
                @if (hasTargeting(flag)) {
                  <mat-chip class="targeting-chip">yes</mat-chip>
                } @else {
                  <span class="no-targeting">-</span>
                }
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let flag" class="col-actions">
                <button
                  mat-icon-button
                  color="warn"
                  (click)="confirmDelete(flag); $event.stopPropagation()"
                  title="Delete"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              [class.selected-row]="row.key === selectedFlagKey()"
              (click)="openEditFlagEditor(row)"
            ></tr>
          </table>
        } @else {
          <div class="empty-flags">
            <p>No flags in this file yet.</p>
            <button mat-flat-button color="primary" (click)="openNewFlagEditor()">
              Create your first flag
            </button>
          </div>
        }
      </div>

      @if (showInlineEditor()) {
        <div class="inline-editor">
          <app-flag-editor
            [inline]="true"
            [flag]="editingFlag()"
            [existingKeys]="existingFlagKeys()"
            (save)="onSaveFlag($event)"
            (cancel)="closeEditor()"
          />
        </div>
      }
    </div>

    @if (showSidePanelEditor()) {
      <app-flag-editor
        [flag]="editingFlag()"
        [existingKeys]="existingFlagKeys()"
        (save)="onSaveFlag($event)"
        (cancel)="closeEditor()"
      />
    }
  </div>

  <app-playground-drawer [flags]="store.flagEntries()" [selectedFlagKey]="selectedFlagKey()" />
</div>
