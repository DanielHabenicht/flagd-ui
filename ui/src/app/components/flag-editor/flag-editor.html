@if (!inline()) {
  <div class="panel-backdrop" (click)="onCancel()"></div>
}
<aside class="side-panel" [class.inline-panel]="inline()">
  <div class="panel-header">
    <h2>{{ isEditing() ? 'Edit Flag' : 'Create Flag' }}</h2>
    <div class="panel-header-actions">
      <mat-button-toggle-group [value]="editorMode()" (change)="setMode($event.value)">
        <mat-button-toggle value="easy"
          [disabled]="!easyModeAvailable() && editorMode() !== 'easy'"
          [title]="!easyModeAvailable() && editorMode() !== 'easy' ? 'This flag uses features not available in easy mode' : ''"
        >Easy</mat-button-toggle>
        <mat-button-toggle value="advanced">Advanced</mat-button-toggle>
        <mat-button-toggle value="json">JSON</mat-button-toggle>
      </mat-button-toggle-group>
      @if (!inline()) {
        <button mat-icon-button (click)="onCancel()">
          <mat-icon>close</mat-icon>
        </button>
      }
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSave()" class="panel-body">
    <!-- Flag Key (shared across all modes) -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Flag Key</mat-label>
      <input matInput formControlName="key" placeholder="my-feature-flag" />
      @if (form.get('key')!.invalid && form.get('key')!.touched) {
        <mat-error>Use only letters, numbers, dots, hyphens, and underscores</mat-error>
      }
      @if (keyAlreadyExists()) {
        <mat-error>A flag with this key already exists in the current file</mat-error>
      }
    </mat-form-field>

    <!-- ==================== EASY MODE ==================== -->
    @if (editorMode() === 'easy') {
      <div class="easy-mode">
        <div class="form-field">
          <label>Flag Type</label>
          <mat-button-toggle-group [value]="form.get('easyType')!.value"
            (change)="form.get('easyType')!.setValue($event.value); onEasyTypeChange()">
            <mat-button-toggle value="boolean">Boolean</mat-button-toggle>
            <mat-button-toggle value="string">String</mat-button-toggle>
          </mat-button-toggle-group>
        </div>

        @if (form.get('easyType')!.value === 'boolean') {
          <div class="easy-toggle-section">
            <div class="easy-toggle-row">
              <mat-slide-toggle
                [checked]="form.get('state')!.value === 'ENABLED'"
                (change)="onEasyStateToggle()"
                labelPosition="before">
                Flag is currently {{ form.get('state')!.value === 'ENABLED' ? 'ON' : 'OFF' }}
              </mat-slide-toggle>
            </div>
            <p class="easy-hint">
               Use the toggle to control whether this flag is enabled.
            </p>
          </div>
        }

        @if (form.get('easyType')!.value === 'string') {
          <div class="easy-string-section">
            <div class="easy-toggle-row">
              <mat-slide-toggle
                [checked]="form.get('state')!.value === 'ENABLED'"
                (change)="onEasyStateToggle()"
                labelPosition="before">
                Enabled {{ form.get('state')!.value === 'ENABLED' ? 'ON' : 'OFF' }}
              </mat-slide-toggle>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Value</mat-label>
              <input matInput formControlName="easyStringValue"
                     placeholder="Enter string value"
                     (input)="onEasyStringValueChange()" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Default Variant</mat-label>
              <mat-select formControlName="defaultVariant">
                <mat-option value="">-- none --</mat-option>
                @for (name of variantNames(); track name) {
                  <mat-option [value]="name">{{ name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        }
      </div>
    }

    <!-- ==================== ADVANCED MODE ==================== -->
    @if (editorMode() === 'advanced') {
      <div class="advanced-mode">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>State</mat-label>
            <mat-select formControlName="state">
              <mat-option value="ENABLED">Enabled</mat-option>
              <mat-option value="DISABLED">Disabled</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Flag Type</mat-label>
            <mat-select formControlName="flagType" (selectionChange)="onTypeChange()">
              <mat-option value="boolean">Boolean</mat-option>
              <mat-option value="string">String</mat-option>
              <mat-option value="number">Number</mat-option>
              <mat-option value="object">Object</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <app-variants-editor
          [flagType]="form.get('flagType')!.value"
          [variants]="variants()"
          (variantsChange)="onVariantsChange($event)"
        />

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Default Variant</mat-label>
          <mat-select formControlName="defaultVariant">
            <mat-option value="">-- none --</mat-option>
            @for (name of variantNames(); track name) {
              <mat-option [value]="name">{{ name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <app-targeting-editor
          [targeting]="targeting()"
          [variantKeys]="variantNames()"
          (targetingChange)="onTargetingChange($event)"
        />
      </div>
    }

    <!-- ==================== JSON MODE ==================== -->
    @if (editorMode() === 'json') {
      <div class="json-mode">
        <div class="json-mode-header">
          <label class="section-label">Flag Definition</label>
          <button mat-stroked-button type="button" (click)="formatJson()">Format</button>
        </div>
        <mat-form-field appearance="outline" class="full-width">
          <textarea matInput
            class="json-editor-textarea"
            [ngModel]="rawJson"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onJsonInput($event)"
            rows="20"
            spellcheck="false"
            placeholder='{ "state": "ENABLED", "variants": { ... } }'
          ></textarea>
        </mat-form-field>
        @if (jsonError) {
          <p class="json-error">{{ jsonError }}</p>
        }
        <p class="json-hint">
          Edit the full flag definition as JSON. Required fields: <code>state</code>, <code>variants</code>.
        </p>
      </div>
    }

    <!-- ==================== ACTIONS ==================== -->
    <div class="panel-actions">
      <button mat-button type="button" (click)="onCancel()">Cancel</button>
      <button mat-flat-button color="primary" type="button" (click)="onSave()" [disabled]="!canSave()">
        {{ isEditing() ? 'Save Changes' : 'Create Flag' }}
      </button>
    </div>
  </form>
</aside>
