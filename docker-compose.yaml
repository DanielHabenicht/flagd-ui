services:
  flagd-ui:
    build:
      context: .
      dockerfile: Dockerfile
    image: flagd-ui:local
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - '3000:3000'
    volumes:
      - ./flags:/app/flags

  flagd:
    image: ghcr.io/open-feature/flagd:latest
    depends_on:
      azurite-init:
        condition: service_completed_successfully
    volumes:
      - ./flags:/flags
    command: [ 'start', '--uri', 'file:./flags/demo.flagd.json' ]
    ports:
      - '8013:8013'
      - '8016:8016'
      - '8014:8014'

  azurite:
    image: local-azurite:latest
    build:
      context: services/azurite
      dockerfile: Dockerfile
    ports:
      - 10000:10000
      - 10001:10001
      - 10002:10002
    volumes:
      - azurite-data:/data
    healthcheck:
      test: ["CMD", "sh", "-c", "pgrep -f azurite > /dev/null"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  azurite-init:
    build:
      context: .
      dockerfile: services/azurite-init/Dockerfile
    depends_on:
      azurite:
        condition: service_healthy
    restart: "no"

  # auth:
  #   image: local-keycloak:latest
  #   build: ./services/authentication
  #   environment:
  #     - KEYCLOAK_ADMIN=admin
  #     - KEYCLOAK_ADMIN_PASSWORD=admin
  #   ports:
  #     - 8080:8080
  #   command:
  #     - start-dev
  #     - --import-realm

volumes:
  azurite-data:

